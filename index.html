<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dasbor Manajemen Konten - EXATA GROUP</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827; /* Dark background */
            color: #d1d5db; /* Light text */
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .status-badge {
            padding: 4px 10px;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .status-pending { background-color: #ca8a04; color: #fefce8; }
        .status-approved { background-color: #16a34a; color: #f0fdf4; }
        .status-revisi { background-color: #dc2626; color: #fef2f2; }
        .modal { transition: opacity 0.3s ease, transform 0.3s ease; }
        .modal-hidden { opacity: 0; transform: scale(0.95); pointer-events: none; }
        .modal-visible { opacity: 1; transform: scale(1); pointer-events: auto; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">
    <!-- Login Overlay -->
    <div id="loginOverlay" class="fixed inset-0 bg-gray-900 bg-opacity-95 flex items-center justify-center z-50">
        <div class="bg-gray-800 p-8 rounded-lg shadow-xl w-full max-w-sm">
            <h2 class="text-2xl font-bold text-white text-center mb-6">Login Dasbor Konten</h2>
            <form id="loginForm">
                <div class="space-y-4">
                    <div>
                        <label for="username" class="block text-sm font-medium text-gray-300 mb-1">Username</label>
                        <input type="text" id="username" required class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:ring-2 focus:ring-blue-500" placeholder="Username Anda">
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium text-gray-300 mb-1">Password</label>
                        <input type="password" id="password" required class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:ring-2 focus:ring-blue-500" placeholder="Password">
                    </div>
                </div>
                <div id="loginError" class="text-red-400 text-sm mt-4 text-center hidden"></div>
                <button type="submit" id="loginButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg mt-6 transition-colors flex items-center justify-center">
                </div>
                <div class="flex items-center justify-between mt-4">
                    <div class="flex items-center">
                        <input id="rememberMe" name="rememberMe" type="checkbox" class="h-4 w-4 bg-gray-700 border-gray-600 text-blue-600 focus:ring-blue-500 rounded">
                        <label for="rememberMe" class="ml-2 block text-sm text-gray-300">Ingat Saya (7 hari)</label>
                    </div>
                </div>
                <div id="loginError" class="text-red-400 text-sm mt-4 text-center hidden"></div>
                <button type="submit" id="loginButton" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg mt-4 transition-colors flex items-center justify-center">
                </button>
            </form>
        </div>
    </div>

    <!-- Main App Content (Initially hidden) -->
    <div id="app" class="max-w-7xl mx-auto hidden">
         <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-white">Dasbor Konten</h1>
                <p id="todayDate" class="text-gray-400 mt-1"></p>
            </div>
            <div class="flex items-center space-x-4">
                 <p id="welcomeMessage" class="text-gray-300"></p>
                <button id="addContentBtn" class="mt-4 sm:mt-0 flex items-center bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    Setor Konten Baru
                </button>
            </div>
        </header>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="flex justify-center items-center py-20">
            <div class="loader"></div>
        </div>
        
        <div id="mainContent" class="hidden">
            <!-- Today's Posting Schedule -->
            <main class="bg-gray-800 p-4 sm:p-6 rounded-lg shadow-lg mb-8">
                <h2 class="text-xl font-semibold text-white mb-4">Jadwal Posting Hari Ini</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-700">
                        <thead class="bg-gray-900/50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Divisi</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">PIC</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Caption</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-300 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="todaysPostsTableBody" class="bg-gray-800 divide-y divide-gray-700"></tbody>
                    </table>
                </div>
            </main>
            
            <!-- All Content -->
            <main class="bg-gray-800 p-4 sm:p-6 rounded-lg shadow-lg">
                <h2 class="text-xl font-semibold text-white mb-4">Semua Konten Terjadwal</h2>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-700">
                         <thead class="bg-gray-900/50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Tgl Posting</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Tgl Setor</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Divisi</th>
                                 <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">PIC</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Caption</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Status</th>
                                <th class="px-6 py-3 text-center text-xs font-medium text-gray-300 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="allPostsTableBody" class="bg-gray-800 divide-y divide-gray-700"></tbody>
                    </table>
                </div>
            </main>
        </div>
    </div>

    <!-- Add/Edit Content Modal -->
    <div id="contentModal" class="modal modal-hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-gray-800 rounded-lg shadow-xl w-full max-w-2xl transform">
            <div class="p-6 border-b border-gray-700 flex justify-between items-center">
                <h3 id="modalTitle" class="text-xl font-semibold text-white">Setor Konten Baru</h3>
                <button id="closeModalBtn" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <form id="contentForm" class="p-6 space-y-4">
                <input type="hidden" id="contentId" name="contentId">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="submitterDivision" class="block text-sm font-medium text-gray-300 mb-1">Divisi</label>
                        <select id="submitterDivision" name="submitterDivision" required class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:ring-2 focus:ring-blue-500">
                            <option value="exata">EXATA</option>
                            <option value="yanoshi">YANOSHI</option>
                            <option value="snopy">SNOPY</option>
                        </select>
                    </div>
                     <div>
                        <label for="postingDate" class="block text-sm font-medium text-gray-300 mb-1">Tanggal & Waktu Posting</label>
                        <input type="datetime-local" id="postingDate" name="postingDate" required class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:ring-2 focus:ring-blue-500">
                    </div>
                </div>
                 <div>
                    <label for="picName" class="block text-sm font-medium text-gray-300 mb-1">PIC (Penanggung Jawab)</label>
                    <select id="picName" name="picName" required class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white focus:ring-2 focus:ring-blue-500">
                        <option>Adam</option>
                        <option>Irfan</option>
                        <option>Teddy</option>
                        <option>Raza</option>
                        <option>Julian</option>
                        <option>Bintang</option>
                        <option>Lutfi</option>
                    </select>
                </div>
                <div>
                    <label for="contentLink" class="block text-sm font-medium text-gray-300 mb-1">Link Konten (Download)</label>
                    <input type="url" id="contentLink" name="contentLink" required class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white" placeholder="https://link-konten-anda.com/file">
                </div>
                <div>
                    <label for="caption" class="block text-sm font-medium text-gray-300 mb-1">Caption</label>
                    <textarea id="caption" name="caption" rows="4" required class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white" placeholder="Tulis caption menarik di sini..."></textarea>
                </div>
                <div>
                    <label for="ctaLink" class="block text-sm font-medium text-gray-300 mb-1">Link CTA (Call to Action)</label>
                    <input type="url" id="ctaLink" name="ctaLink" required class="w-full bg-gray-700 border border-gray-600 rounded-md py-2 px-3 text-white" placeholder="https://link-cta-anda.com/promo">
                </div>
                <div class="flex justify-end pt-4">
                    <button type="button" id="cancelBtn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg mr-2">Batal</button>
                    <button type="submit" id="saveButton" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">Simpan</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-5 right-5 bg-green-600 text-white py-2 px-5 rounded-lg shadow-lg opacity-0 translate-y-10 transition-all duration-300"></div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // !!! PENTING: Ganti URL ini dengan URL Web App Anda setelah deploy !!!
            const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbw6Pszy0vjz95gVzSk_mNpP3WIT3UFODMX78c7bw1KbCFCZKmVpCD9Ai1z3OreBcVxP4w/exec';

            // --- TAMBAHKAN LOGIKA AUTO LOGIN DI SINI ---
            const savedUser = JSON.parse(localStorage.getItem('savedUser'));
            if (savedUser && new Date().getTime() < savedUser.expiry) {
                // Tampilkan loading dan coba login otomatis
                document.getElementById('username').value = savedUser.username;
                document.getElementById('password').value = savedUser.password;
                document.getElementById('loginButton').click(); // Simulasikan klik pada tombol login
            }
            // --- AKHIR LOGIKA AUTO LOGIN ---

            const state = {
                allContent: [],
                currentUser: null
            };

            // --- DOM SELECTORS ---
            const loginOverlay = document.getElementById('loginOverlay');
            const loginForm = document.getElementById('loginForm');
            const loginButton = document.getElementById('loginButton');
            const loginButtonText = document.getElementById('loginButtonText');
            const loginSpinner = document.getElementById('loginSpinner');
            const loginError = document.getElementById('loginError');

            const appContainer = document.getElementById('app');
            const loadingIndicator = document.getElementById('loadingIndicator');
            const mainContent = document.getElementById('mainContent');
            const welcomeMessage = document.getElementById('welcomeMessage');

            const todaysPostsTableBody = document.getElementById('todaysPostsTableBody');
            const allPostsTableBody = document.getElementById('allPostsTableBody');
            
            const modal = document.getElementById('contentModal');
            const addContentBtn = document.getElementById('addContentBtn');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const cancelBtn = document.getElementById('cancelBtn');
            const contentForm = document.getElementById('contentForm');
            const modalTitle = document.getElementById('modalTitle');
            const contentIdInput = document.getElementById('contentId');
            const toast = document.getElementById('toast');

            // --- FUNGSI HELPER BARU ---
            function formatDateTimeWIB(dateString) {
                if (!dateString) return '';
                const date = new Date(dateString);
                const options = {
                    year: 'numeric', month: '2-digit', day: '2-digit',
                    hour: '2-digit', minute: '2-digit', hour12: false,
                    timeZone: 'Asia/Jakarta'
                };
                const parts = new Intl.DateTimeFormat('id-ID', options).formatToParts(date);
                const partValue = (type) => parts.find(p => p.type === type)?.value || '';
                
                const y = partValue('year');
                const m = partValue('month');
                const d = partValue('day');
                const h = partValue('hour');
                const min = partValue('minute');

                return `${y}-${m}-${d} ${h}:${min} WIB`;
            }

            function formatDateWIB(dateString) {
                 if (!dateString) return '';
                const date = new Date(dateString);
                const options = { year: 'numeric', month: '2-digit', day: '2-digit', timeZone: 'Asia/Jakarta' };
                const [day, month, year] = new Intl.DateTimeFormat('id-ID', options).format(date).split('/');
                return `${year}-${month}-${day}`;
            }
            
            // --- API FUNCTIONS ---
            async function callAppsScript(action, payload = {}) {
                try {
                    const res = await fetch(SCRIPT_URL, {
                        method: 'POST',
                        body: JSON.stringify({ action, ...payload })
                    });
                    if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
                    return await res.json();
                } catch (error) {
                    console.error('Error calling Apps Script:', error);
                    showToast('Terjadi kesalahan koneksi', true);
                    return { success: false, error: error.message };
                }
            }

            // --- RENDER FUNCTIONS ---
            function createTableRow(item) {
                const statusClass = { 'Pending': 'status-pending', 'Approved': 'status-approved', 'Revisi': 'status-revisi' }[item.status];
                const isAdmin = state.currentUser.role === 'superadmin';

                const adminActions = `
                    <button data-id="${item.id}" class="edit-btn text-yellow-400 hover:text-yellow-300" title="Ubah Konten">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
                    </button>
                    <button data-id="${item.id}" class="delete-btn text-red-500 hover:text-red-400" title="Hapus Konten">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>
                    </button>
                `;

                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-700/50 transition-colors';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${formatDateTimeWIB(item.postingDate)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-400">${formatDateWIB(item.submissionDate)}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white uppercase">${item.division}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${item.pic}</td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-gray-300 max-w-xs truncate" title="${item.caption}">${item.caption}</div>
                        <div class="text-xs text-blue-400 mt-1 truncate">CTA: <a href="${item.ctaLink}" target="_blank" class="hover:underline">${item.ctaLink}</a></div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap"><span class="status-badge ${statusClass}">${item.status}</span></td>
                    <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                        <div class="flex items-center justify-center space-x-2">
                            <a href="${item.contentLink}" download target="_blank" title="Download Konten" class="text-green-400 hover:text-green-300"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></a>
                            <button data-copy-caption="${item.caption}" title="Salin Caption" class="text-blue-400 hover:text-blue-300"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></button>
                            ${isAdmin ? `<select data-id="${item.id}" class="status-selector bg-gray-700 text-white text-xs rounded border border-gray-600 focus:ring-blue-500 focus:border-blue-500 p-1">
                                <option value="Pending" ${item.status === 'Pending' ? 'selected' : ''}>Pending</option>
                                <option value="Approved" ${item.status === 'Approved' ? 'selected' : ''}>Approved</option>
                                <option value="Revisi" ${item.status === 'Revisi' ? 'selected' : ''}>Revisi</option>
                            </select>` : ''}
                             ${isAdmin ? adminActions : ''}
                        </div>
                    </td>`;
                return row;
            }
             function createTodayTableRow(item) {
                const statusClass = { 'Pending': 'status-pending', 'Approved': 'status-approved', 'Revisi': 'status-revisi' }[item.status];
                const isAdmin = state.currentUser.role === 'superadmin';
                 const row = document.createElement('tr');
                row.className = 'hover:bg-gray-700/50 transition-colors';
                row.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white uppercase">${item.division}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${item.pic}</td>
                    <td class="px-6 py-4">
                        <div class="text-sm text-gray-300 max-w-xs truncate" title="${item.caption}">${item.caption}</div>
                        <div class="text-xs text-blue-400 mt-1 truncate">CTA: <a href="${item.ctaLink}" target="_blank" class="hover:underline">${item.ctaLink}</a></div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap"><span class="status-badge ${statusClass}">${item.status}</span></td>
                    <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                         <div class="flex items-center justify-center space-x-2">
                            <a href="${item.contentLink}" download target="_blank" title="Download Konten" class="text-green-400 hover:text-green-300"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg></a>
                            <button data-copy-caption="${item.caption}" title="Salin Caption" class="text-blue-400 hover:text-blue-300"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path></svg></button>
                             ${isAdmin ? `<select data-id="${item.id}" class="status-selector bg-gray-700 text-white text-xs rounded border border-gray-600 focus:ring-blue-500 focus:border-blue-500 p-1">
                                <option value="Pending" ${item.status === 'Pending' ? 'selected' : ''}>Pending</option>
                                <option value="Approved" ${item.status === 'Approved' ? 'selected' : ''}>Approved</option>
                                <option value="Revisi" ${item.status === 'Revisi' ? 'selected' : ''}>Revisi</option>
                            </select>` : ''}
                        </div>
                    </td>`;
                return row;
            }

            async function renderDashboard() {
                loadingIndicator.style.display = 'flex';
                mainContent.classList.add('hidden');

                const result = await callAppsScript('getContent');
                if (result.success) {
                    state.allContent = result.data;
                } else {
                    state.allContent = [];
                    showToast('Gagal memuat data konten', true);
                }
                
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('todayDate').textContent = new Date().toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });

                const todaysPosts = state.allContent.filter(item => item.postingDate === today);
                const allPosts = [...state.allContent].sort((a,b) => new Date(b.postingDate) - new Date(a.postingDate));

                // Render today's posts
                todaysPostsTableBody.innerHTML = '';
                if (todaysPosts.length > 0) {
                    todaysPosts.forEach(item => todaysPostsTableBody.appendChild(createTodayTableRow(item)));
                } else {
                    todaysPostsTableBody.innerHTML = `<tr><td colspan="5" class="text-center py-10 text-gray-400">Tidak ada jadwal posting untuk hari ini.</td></tr>`;
                }

                // Render all posts
                allPostsTableBody.innerHTML = '';
                 if (allPosts.length > 0) {
                    allPosts.forEach(item => allPostsTableBody.appendChild(createTableRow(item)));
                } else {
                    allPostsTableBody.innerHTML = `<tr><td colspan="7" class="text-center py-10 text-gray-400">Belum ada konten yang disetor.</td></tr>`;
                }

                loadingIndicator.style.display = 'none';
                mainContent.classList.remove('hidden');
            }

            // --- UI LOGIC ---
            function showModal(isEdit = false, content = null) {
                contentForm.reset();
                if (isEdit && content) {
                    modalTitle.textContent = 'Ubah Konten';
                    contentIdInput.value = content.id;
                    document.getElementById('submitterDivision').value = content.division;
                    document.getElementById('postingDate').value = content.postingDate.slice(0, 16);
                    document.getElementById('picName').value = content.pic;
                    document.getElementById('contentLink').value = content.contentLink;
                    document.getElementById('caption').value = content.caption;
                    document.getElementById('ctaLink').value = content.ctaLink;
                } else {
                    modalTitle.textContent = 'Setor Konten Baru';
                    contentIdInput.value = '';
                }
                modal.classList.remove('modal-hidden');
                modal.classList.add('modal-visible');
            }

            function hideModal() {
                modal.classList.add('modal-hidden');
                modal.classList.remove('modal-visible');
            }

            function showToast(message, isError = false) {
                toast.textContent = message;
                toast.className = `fixed bottom-5 right-5 text-white py-2 px-5 rounded-lg shadow-lg opacity-0 translate-y-10 transition-all duration-300 ${isError ? 'bg-red-600' : 'bg-green-600'}`;
                toast.classList.remove('opacity-0', 'translate-y-10');
                toast.classList.add('opacity-100', 'translate-y-0');
                setTimeout(() => {
                    toast.classList.remove('opacity-100', 'translate-y-0');
                    toast.classList.add('opacity-0', 'translate-y-10');
                }, 3000);
            }
            
            function toggleLoginButton(isLoading) {
                loginButton.disabled = isLoading;
                loginButtonText.classList.toggle('hidden', isLoading);
                loginSpinner.classList.toggle('hidden', !isLoading);
            }

            // --- EVENT HANDLERS ---
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                toggleLoginButton(true);
                loginError.classList.add('hidden');
                
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const rememberMe = document.getElementById('rememberMe').checked;
                
                const result = await callAppsScript('login', { username, password });

                toggleLoginButton(false);

                if (result.success) {
                    // Jika login berhasil dan "Ingat Saya" dicentang
                    if (rememberMe) {
                        const expiry = new Date().getTime() + (7 * 24 * 60 * 60 * 1000); // 7 hari dari sekarang
                        localStorage.setItem('savedUser', JSON.stringify({ username, password, expiry }));
                    } else {
                        localStorage.removeItem('savedUser');
                    }

                    state.currentUser = result.user;
                    loginOverlay.style.display = 'none';
                    appContainer.classList.remove('hidden');
                    welcomeMessage.textContent = `Selamat datang, ${state.currentUser.username} (${state.currentUser.role})!`;
                    await renderDashboard();
                } else {
                    localStorage.removeItem('savedUser'); // Hapus jika login gagal
                    loginError.textContent = result.message || 'Username atau password salah.';
                    loginError.classList.remove('hidden');
                }
            });

            addContentBtn.addEventListener('click', () => showModal());
            closeModalBtn.addEventListener('click', hideModal);
            cancelBtn.addEventListener('click', hideModal);
            
            contentForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const id = contentIdInput.value;
                const isEdit = !!id;

                const payload = {
                    id: id,
                    postingDate: document.getElementById('postingDate').value,
                    division: document.getElementById('submitterDivision').value,
                    pic: document.getElementById('picName').value,
                    caption: document.getElementById('caption').value,
                    ctaLink: document.getElementById('ctaLink').value,
                    contentLink: document.getElementById('contentLink').value,
                };
                
                const action = isEdit ? 'editContent' : 'addContent';
                const result = await callAppsScript(action, { content: payload });

                if (result.success) {
                    hideModal();
                    await renderDashboard();
                    showToast(isEdit ? 'Konten berhasil diubah!' : 'Konten baru berhasil disetor!');
                } else {
                    showToast(result.error || 'Gagal menyimpan data', true);
                }
            });
            
            appContainer.addEventListener('change', async (e) => {
                if (e.target.classList.contains('status-selector')) {
                    const id = e.target.dataset.id;
                    const newStatus = e.target.value;
                    const result = await callAppsScript('updateStatus', { id, status: newStatus });
                     if (result.success) {
                        await renderDashboard();
                        showToast(`Status berhasil diubah menjadi ${newStatus}`);
                    } else {
                        showToast('Gagal mengubah status', true);
                    }
                }
            });
            
            appContainer.addEventListener('click', async (e) => {
                const copyCaptionBtn = e.target.closest('[data-copy-caption]');
                if (copyCaptionBtn) {
                    navigator.clipboard.writeText(copyCaptionBtn.dataset.copyCaption).then(() => showToast('Caption berhasil disalin!'));
                    return;
                }

                const editBtn = e.target.closest('.edit-btn');
                if (editBtn) {
                    const id = editBtn.dataset.id;
                    const contentItem = state.allContent.find(item => item.id == id);
                    if(contentItem) showModal(true, contentItem);
                    return;
                }

                const deleteBtn = e.target.closest('.delete-btn');
                if (deleteBtn) {
                    const id = deleteBtn.dataset.id;
                    if (confirm('Apakah Anda yakin ingin menghapus konten ini?')) {
                        const result = await callAppsScript('deleteContent', { id });
                        if (result.success) {
                            await renderDashboard();
                            showToast('Konten berhasil dihapus!');
                        } else {
                            showToast('Gagal menghapus konten', true);
                        }
                    }
                }
            });
        });
    </script>
</body>
</html>
